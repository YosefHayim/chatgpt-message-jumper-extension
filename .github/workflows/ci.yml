name: CI/CD Pipeline

on:
  push:
    branches:
      - main
      - develop
  pull_request:
    branches:
      - main
      - develop
      - 'claude/**'
      - 'feature/**'
      - 'fix/**'

jobs:
  test:
    name: Test & Coverage
    runs-on: ubuntu-latest

    strategy:
      matrix:
        node-version: [18.x, 20.x]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run linting (if configured)
        run: npm run lint || echo "No linting configured"
        continue-on-error: true

      - name: Run tests with coverage
        run: npm run test:coverage

      - name: Check coverage threshold
        run: |
          echo "Checking test coverage..."

          # Extract coverage percentages from Jest output
          COVERAGE_REPORT=$(npm run test:coverage --silent 2>&1 || true)

          # Parse coverage (statements, branches, functions, lines)
          STATEMENTS=$(echo "$COVERAGE_REPORT" | grep "All files" | awk '{print $10}' | tr -d '%')
          BRANCHES=$(echo "$COVERAGE_REPORT" | grep "All files" | awk '{print $11}' | tr -d '%')
          FUNCTIONS=$(echo "$COVERAGE_REPORT" | grep "All files" | awk '{print $12}' | tr -d '%')
          LINES=$(echo "$COVERAGE_REPORT" | grep "All files" | awk '{print $13}' | tr -d '%')

          echo "Coverage Report:"
          echo "  Statements: ${STATEMENTS}%"
          echo "  Branches: ${BRANCHES}%"
          echo "  Functions: ${FUNCTIONS}%"
          echo "  Lines: ${LINES}%"

          # Check if all coverage metrics meet 90% threshold
          THRESHOLD=90

          if (( $(echo "$STATEMENTS < $THRESHOLD" | bc -l) )); then
            echo "❌ ERROR: Statement coverage ($STATEMENTS%) is below $THRESHOLD%"
            exit 1
          fi

          if (( $(echo "$BRANCHES < $THRESHOLD" | bc -l) )); then
            echo "⚠️  WARNING: Branch coverage ($BRANCHES%) is below $THRESHOLD%"
            # Uncomment to enforce branch coverage
            # exit 1
          fi

          if (( $(echo "$FUNCTIONS < $THRESHOLD" | bc -l) )); then
            echo "❌ ERROR: Function coverage ($FUNCTIONS%) is below $THRESHOLD%"
            exit 1
          fi

          if (( $(echo "$LINES < $THRESHOLD" | bc -l) )); then
            echo "❌ ERROR: Line coverage ($LINES%) is below $THRESHOLD%"
            exit 1
          fi

          echo "✅ All coverage thresholds met!"

      - name: Upload coverage reports to Codecov
        uses: codecov/codecov-action@v3
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: ./coverage/coverage-final.json
          flags: unittests
          name: codecov-umbrella
          fail_ci_if_error: false

      - name: Comment PR with coverage
        if: github.event_name == 'pull_request'
        uses: romeovs/lcov-reporter-action@v0.3.1
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          lcov-file: ./coverage/lcov.info
        continue-on-error: true

  build:
    name: Build Extension
    runs-on: ubuntu-latest
    needs: test

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build extension
        run: npm run build

      - name: Verify build outputs
        run: |
          echo "Verifying build outputs..."

          # Check dist directory exists
          if [ ! -d "dist" ]; then
            echo "❌ ERROR: dist directory not found"
            exit 1
          fi

          # Check required files
          REQUIRED_FILES=(
            "dist/manifest.json"
            "dist/content.js"
            "dist/popup.js"
            "dist/popup.html"
            "dist/popup.css"
            "dist/styles.css"
          )

          for file in "${REQUIRED_FILES[@]}"; do
            if [ ! -f "$file" ]; then
              echo "❌ ERROR: Required file not found: $file"
              exit 1
            fi
            echo "✅ Found: $file"
          done

          # Check icons directory
          if [ ! -d "dist/icons" ]; then
            echo "❌ ERROR: dist/icons directory not found"
            exit 1
          fi

          echo "✅ All required files present!"

      - name: Upload build artifact
        uses: actions/upload-artifact@v3
        with:
          name: extension-build
          path: dist/
          retention-days: 7

  build-release-packages:
    name: Build Release Packages
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/tags/')

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build Chrome/Edge package
        run: npm run build:chrome

      - name: Build Firefox package
        run: npm run build:firefox

      - name: Upload Chrome/Edge package
        uses: actions/upload-artifact@v3
        with:
          name: chrome-edge-package
          path: ai-conversation-navigator-chrome.zip
          retention-days: 30

      - name: Upload Firefox package
        uses: actions/upload-artifact@v3
        with:
          name: firefox-package
          path: ai-conversation-navigator-firefox.zip
          retention-days: 30

  auto-merge:
    name: Auto-merge on main
    runs-on: ubuntu-latest
    needs: [test, build]
    if: |
      github.event_name == 'pull_request' &&
      github.base_ref == 'main' &&
      github.actor == 'dependabot[bot]' ||
      contains(github.event.pull_request.labels.*.name, 'auto-merge')

    steps:
      - name: Auto-merge
        uses: pascalgn/automerge-action@v0.15.6
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          MERGE_LABELS: "auto-merge"
          MERGE_METHOD: "squash"
          MERGE_COMMIT_MESSAGE: "pull-request-title"
          MERGE_DELETE_BRANCH: true

  notify:
    name: Notify on failure
    runs-on: ubuntu-latest
    needs: [test, build]
    if: failure()

    steps:
      - name: Notify via GitHub commit status
        run: |
          echo "❌ Pipeline failed for commit ${{ github.sha }}"
          echo "Branch: ${{ github.ref }}"
          echo "Actor: ${{ github.actor }}"
          echo "Event: ${{ github.event_name }}"
